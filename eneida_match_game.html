<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–Ω–µ—ó–¥–∞: –ó–Ω–∞–π–¥–∏ –°–≤–æ–≥–æ –ö–æ–∑–∞–∫–∞!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8; /* Light neutral background */
            color: #4B4B4B; /* Dark grey text */
        }
        .game-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.08), 0 5px 10px -5px rgba(0, 0, 0, 0.03);
            padding: 2rem;
            text-align: center;
        }
        .btn-primary {
            background-color: #F97316; /* Orange */
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 0.75rem;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #EA580C; /* Darker orange */
            transform: translateY(-2px);
        }
        .draggable-item {
            background-color: #FEF3C7; /* Light amber */
            border: 2px solid #FCD34D; /* Amber border */
            color: #78350F; /* Dark amber text */
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: grab;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-width: 120px; /* Ensure items have enough width */
            text-align: center;
        }
        .draggable-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .draggable-item.dragging {
            opacity: 0.7;
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .drop-target {
            background-color: #F3F4F6; /* Light grey */
            border: 2px dashed #D1D5DB; /* Dashed grey border */
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 8rem; /* Ensure enough height for content */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.95rem;
            color: #4B5563; /* Darker grey text */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-target.hovered {
            background-color: #E5E7EB; /* Slightly darker on hover */
            border-color: #9CA3AF; /* Darker dashed border */
        }
        .drop-target.correct {
            background-color: #D1FAE5; /* Light green */
            border-color: #10B981; /* Green */
            color: #065F46; /* Dark green text */
        }
        .drop-target.incorrect {
            background-color: #FEE2E2; /* Light red */
            border-color: #EF4444; /* Red */
            color: #991B1B; /* Dark red text */
        }
        .drop-target.correct .draggable-item {
            background-color: #A7F3D0; /* Lighter green for item inside correct target */
            border-color: #065F46;
            color: #064E40;
            cursor: default;
        }
        .drop-target.incorrect .draggable-item {
            background-color: #FECACA; /* Lighter red for item inside incorrect target */
            border-color: #991B1B;
            color: #7F1D1D;
            cursor: default;
        }
        .message-box {
            background-color: #ECFDF5; /* Light emerald for explanation */
            border: 1px solid #A7F3D0; /* Emerald border */
            color: #065F46; /* Dark emerald text */
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            text-align: left;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 sm:p-6 lg:p-8">

    <div id="game-app" class="w-full max-w-3xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-orange-700 leading-tight">–ï–Ω–µ—ó–¥–∞: –ó–Ω–∞–π–¥–∏ –°–≤–æ–≥–æ –ö–æ–∑–∞–∫–∞! ü§†</h1>
            <p class="text-lg text-stone-600 mt-2">–ü–µ—Ä–µ—Ç—è–≥–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤ —Ç–∞ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–æ —ó—Ö–Ω—ñ—Ö –æ–ø–∏—Å—ñ–≤!</p>
        </header>

        <main id="game-content">
            <section id="intro-screen" class="game-card p-8 sm:p-10">
                <h2 class="text-2xl sm:text-3xl font-bold text-stone-800 mb-6">–ü—Ä–∏–≤—ñ—Ç, –º–∞–π–±—É—Ç–Ω—ñ–π –ó–Ω–∞–≤—Ü—é "–ï–Ω–µ—ó–¥–∏"!</h2>
                <p class="text-stone-700 mb-8 leading-relaxed">
                    –ì–æ—Ç–æ–≤–∏–π –∑–∞–Ω—É—Ä–∏—Ç–∏—Å—è —É —Å–≤—ñ—Ç, –¥–µ –∞–Ω—Ç–∏—á–Ω—ñ –≥–µ—Ä–æ—ó —Å—Ç–∞–ª–∏ –∫–æ–∑–∞–∫–∞–º–∏, –∞ –±–æ–≥–∏ –ø'—é—Ç—å –≥–æ—Ä—ñ–ª–∫—É? –ü–µ—Ä–µ—Ç—è–≥–Ω–∏ –∫–∞—Ä—Ç–∫–∏ –∑ —ñ–º–µ–Ω–∞–º–∏ –∞–±–æ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏ "–ï–Ω–µ—ó–¥–∏" –¥–æ —ó—Ö–Ω—ñ—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –æ–ø–∏—Å—ñ–≤. –ü–æ–∫–∞–∂–∏, —Ö—Ç–æ —Ç—É—Ç —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –∑–Ω–∞–≤–µ—Ü—å –ö–æ—Ç–ª—è—Ä–µ–≤—Å—å–∫–æ–≥–æ!
                </p>
                <button id="start-game-btn" class="btn-primary w-full">–ü–æ—á–∞—Ç–∏ –≥—Ä—É!</button>
            </section>

            <section id="quiz-screen" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <p id="matched-count" class="text-stone-600 font-medium">–ó—ñ—Å—Ç–∞–≤–ª–µ–Ω–æ: 0/12</p>
                    <p id="score-display" class="text-emerald-600 font-bold text-xl">‚ú® 0</p>
                </div>
                <div class="w-full bg-stone-200 rounded-full h-2.5 mb-6">
                    <div id="progress-bar-fill" class="bg-orange-500 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                </div>

                <div class="game-card p-6 sm:p-8 mb-6">
                    <h3 class="text-xl sm:text-2xl font-bold text-stone-800 text-center mb-6">–ü–µ—Ä—Å–æ–Ω–∞–∂—ñ —Ç–∞ –ï–ª–µ–º–µ–Ω—Ç–∏:</h3>
                    <div id="draggable-items-container" class="flex flex-wrap justify-center gap-4 mb-8">
                        <!-- Draggable items will be injected here -->
                    </div>
                    
                    <h3 class="text-xl sm:text-2xl font-bold text-stone-800 text-center mb-6">–û–ø–∏—Å–∏:</h3>
                    <div id="drop-targets-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Drop targets will be injected here -->
                    </div>
                </div>
                
                <div id="feedback-message" class="message-box hidden"></div>
                <div id="llm-explanation" class="llm-explanation-box hidden"></div>
                <button id="check-answers-btn" class="btn-primary w-full mt-8 hidden">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</button>
            </section>

            <section id="results-screen" class="hidden game-card p-8 sm:p-10">
                <h2 class="text-3xl sm:text-4xl font-bold text-orange-700 mb-4">–¢–≤–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏! üéâ</h2>
                <p id="final-score" class="text-5xl font-extrabold text-emerald-600 my-8"></p>
                <p id="result-message" class="text-lg text-stone-700 mb-8 leading-relaxed">
                    –î—è–∫—É—é –∑–∞ –≥—Ä—É! –°–ø–æ–¥—ñ–≤–∞—é—Å—è, —Ç–∏ –ø–æ–≥–ª–∏–±–∏–≤ —Å–≤–æ—ó –∑–Ω–∞–Ω–Ω—è –ø—Ä–æ "–ï–Ω–µ—ó–¥—É" –ö–æ—Ç–ª—è—Ä–µ–≤—Å—å–∫–æ–≥–æ!
                </p>
                <button id="restart-game-btn" class="btn-primary">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑!</button>
            </section>
        </main>

        <footer class="text-center mt-12 text-stone-500 text-sm">
            <p>&copy; 2025 –í–∞—à –±–ª–æ–≥ "–°–ª–æ–≤–æ –Ω–∞ –¥–æ–ª–æ–Ω—ñ". –ù–∞—Ç—Ö–Ω–µ–Ω–æ –≥–µ–Ω—ñ—î–º –ö–æ—Ç–ª—è—Ä–µ–≤—Å—å–∫–æ–≥–æ.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameData = [
                {
                    item: "–ï–Ω–µ–π",
                    description: "–ì–æ–ª–æ–≤–Ω–∏–π –≥–µ—Ä–æ–π, —â–æ –ø—ñ—Å–ª—è –ø–∞–¥—ñ–Ω–Ω—è –¢—Ä–æ—ó —à—É–∫–∞—î –Ω–æ–≤—É –±–∞—Ç—å–∫—ñ–≤—â–∏–Ω—É, –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏–≤—à–∏—Å—å –Ω–∞ –∑–∞–≤–∑—è—Ç–æ–≥–æ –∫–æ–∑–∞–∫–∞.",
                    category: "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                },
                {
                    item: "–î—ñ–¥–æ–Ω–∞",
                    description: "–¶–∞—Ä–∏—Ü—è –ö–∞—Ä—Ñ–∞–≥–µ–Ω–∞, —è–∫–∞ –∑–∞–∫–æ—Ö–∞–ª–∞—Å—è –≤ –ï–Ω–µ—è, –∞–ª–µ –±—É–ª–∞ –Ω–∏–º –ø–æ–∫–∏–Ω—É—Ç–∞, —ñ –∑ –≥–æ—Ä—è —Å–ø–∞–ª–∏–ª–∞ —Å–µ–±–µ.",
                    category: "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                },
                {
                    item: "–ó–µ–≤—Å (–Æ–ø—ñ—Ç–µ—Ä)",
                    description: "–í–µ—Ä—Ö–æ–≤–Ω–∏–π –±–æ–≥, —è–∫–∏–π —É –ø–æ–µ–º—ñ –ö–æ—Ç–ª—è—Ä–µ–≤—Å—å–∫–æ–≥–æ —á–∞—Å—Ç–æ –∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —è–∫ –ª–µ–¥–∞—á–∏–π —ñ –≥—É–ª—å—Ç—è—â–∏–π –¥—ñ–¥—É–≥–∞–Ω.",
                    category: "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                },
                {
                    item: "–í–µ–Ω–µ—Ä–∞",
                    description: "–ë–æ–≥–∏–Ω—è –∫–æ—Ö–∞–Ω–Ω—è, –º–∞—Ç–∏ –ï–Ω–µ—è, —è–∫–∞ –¥–æ–ø–æ–º–∞–≥–∞—î –π–æ–º—É –≤ –ø—Ä–∏–≥–æ–¥–∞—Ö.",
                    category: "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                },
                {
                    item: "–í–∞—Ä–µ–Ω–∏–∫–∏",
                    description: "–£–ª—é–±–ª–µ–Ω–∞ —ó–∂–∞ –∫–æ–∑–∞–∫—ñ–≤-—Ç—Ä–æ—è–Ω—Ü—ñ–≤, —â–æ —á–∞—Å—Ç–æ –∑–≥–∞–¥—É—î—Ç—å—Å—è –≤ –ø–æ–µ–º—ñ —è–∫ —Å–∏–º–≤–æ–ª —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –ø–æ–±—É—Ç—É.",
                    category: "–ï–ª–µ–º–µ–Ω—Ç –ø–æ–±—É—Ç—É"
                },
                {
                    item: "–ù–∏–∑ —Ç–∞ –ï–≤—Ä—ñ–∞–ª",
                    description: "–î–≤–∞ –≤—ñ—Ä–Ω—ñ –¥—Ä—É–∑—ñ-–≤–æ—ó–Ω–∏, —è–∫—ñ –∑–∞–≥–∏–Ω—É–ª–∏, –Ω–∞–º–∞–≥–∞—é—á–∏—Å—å –ø—Ä–æ–±—Ä–∞—Ç–∏—Å—è –¥–æ –≤–æ—Ä–æ–∂–æ–≥–æ —Ç–∞–±–æ—Ä—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ï–Ω–µ—è.",
                    category: "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                },
                {
                    item: "–õ–∞—Ç–∏–Ω",
                    description: "–¶–∞—Ä –õ–∞—Ç–∏–Ω—Å—å–∫–æ—ó –∑–µ–º–ª—ñ, —â–æ –≥–æ—Å—Ç–∏–Ω–Ω–æ –ø—Ä–∏–π–º–∞—î –ï–Ω–µ—è, –∞ –π–æ–≥–æ –¥–æ—á–∫–∞ –õ–∞–≤—ñ–Ω—ñ—è –º–∞—î —Å—Ç–∞—Ç–∏ –¥—Ä—É–∂–∏–Ω–æ—é —Ç—Ä–æ—è–Ω—Ü—è.",
                    category: "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                },
                {
                    item: "–¢—É—Ä–Ω",
                    description: "–¶–∞—Ä —Ä—É—Ç—É–ª—å—Ü—ñ–≤, –≥–æ–ª–æ–≤–Ω–∏–π –≤–æ—Ä–æ–≥ –ï–Ω–µ—è –≤ –õ–∞—Ç–∏–Ω—Å—å–∫—ñ–π –∑–µ–º–ª—ñ, —è–∫–∏–π –±–æ—Ä–µ—Ç—å—Å—è –∑–∞ —Ä—É–∫—É –õ–∞–≤—ñ–Ω—ñ—ó.",
                    category: "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                },
                {
                    item: "–î–µ –∑–≥–æ–¥–∞ –≤ —Å—ñ–º–µ–π—Å—Ç–≤—ñ, –¥–µ –º–∏—Ä —ñ —Ç–∏—à–∏–Ω–∞, –©–∞—Å–ª–∏–≤—ñ —Ç–∞–º –ª—é–¥–∏, –±–ª–∞–∂–µ–Ω–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞.",
                    description: "–¶–∏—Ç–∞—Ç–∞ –∑ –ø–æ–µ–º–∏, —â–æ –ø—ñ–¥–∫—Ä–µ—Å–ª—é—î –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—å –≥–∞—Ä–º–æ–Ω—ñ—ó —Ç–∞ –∑–ª–∞–≥–æ–¥–∏ –≤ —Ä–æ–¥–∏–Ω—ñ.",
                    category: "–¶–∏—Ç–∞—Ç–∞"
                },
                {
                    item: "–ë—É–ª–∞ —Ü–µ –¥—ñ–≤–∫–∞ –º–æ–ª–æ–¥–∞, –Ü—â–µ –±—É–ª–∞ –Ω—ñ—á–æ–≥–æ —Å–æ–±—ñ, –•–æ—Ç—å —ñ –Ω–µ –ø–∏—à–Ω–∞, –Ω–µ –≤—Ä–æ–¥–ª–∏–≤–∞, –ó–∞—Ç–µ –ø—Ä–æ–≤–æ—Ä–Ω–∞ —ñ –º–µ—Ç–∫–∞.",
                    description: "–û–ø–∏—Å –õ–∞–≤—ñ–Ω—ñ—ó, —â–æ –ø–æ–∫–∞–∑—É—î —ó—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –∞ –Ω–µ –ª–∏—à–µ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Å—Ç—å.",
                    category: "–¶–∏—Ç–∞—Ç–∞"
                },
                {
                    item: "–ö–æ–ª–∏ –ï–Ω–µ–π –±—É–≤ –Ω–∞ –û–ª—ñ–º–ø—ñ, –¢–æ–¥—ñ —ñ –ó–µ–≤—Å –±—É–≤ –Ω–∞ –±–µ–Ω–∫–µ—Ç—ñ, –Ü –ø–∏–≤ –≥–æ—Ä—ñ–ª–∫—É, —è–∫ —ñ –≤—Å—ñ, –Ü —ó–≤ –≤–∞—Ä–µ–Ω–∏–∫–∏, —è–∫ —Å–≤–∏–Ω—ñ.",
                    description: "–ì—É–º–æ—Ä–∏—Å—Ç–∏—á–Ω–∏–π –æ–ø–∏—Å –±–æ–≥—ñ–≤, —â–æ –ø–æ–∫–∞–∑—É—î —ó—Ö–Ω—ñ '–ª—é–¥—Å—å–∫—ñ' —Ä–∏—Å–∏ —Ç–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –∫–æ–ª–æ—Ä–∏—Ç.",
                    category: "–¶–∏—Ç–∞—Ç–∞"
                },
                {
                    item: "–ì–æ—Ä—ñ–ª–∫–∞",
                    description: "–ù–∞–ø—ñ–π, —â–æ —á–∞—Å—Ç–æ –∑–≥–∞–¥—É—î—Ç—å—Å—è –≤ –ø–æ–µ–º—ñ, –ø—ñ–¥–∫—Ä–µ—Å–ª—é—é—á–∏ –Ω–∞—Ä–æ–¥–Ω–∏–π –ø–æ–±—É—Ç —Ç–∞ –≥—É–º–æ—Ä –ö–æ—Ç–ª—è—Ä–µ–≤—Å—å–∫–æ–≥–æ.",
                    category: "–ï–ª–µ–º–µ–Ω—Ç –ø–æ–±—É—Ç—É"
                }
            ];

            const introScreen = document.getElementById('intro-screen');
            const quizScreen = document.getElementById('quiz-screen');
            const resultsScreen = document.getElementById('results-screen');
            
            const startGameBtn = document.getElementById('start-game-btn');
            const restartGameBtn = document.getElementById('restart-game-btn');
            const checkAnswersBtn = document.getElementById('check-answers-btn');
            
            const draggableItemsContainer = document.getElementById('draggable-items-container');
            const dropTargetsContainer = document.getElementById('drop-targets-container');
            const matchedCountDisplay = document.getElementById('matched-count');
            const scoreDisplay = document.getElementById('score-display');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const feedbackMessage = document.getElementById('feedback-message');
            const llmExplanationDiv = document.getElementById('llm-explanation');
            const finalScoreDisplay = document.getElementById('final-score');
            const resultMessage = document.getElementById('result-message');

            const totalItems = gameData.length; // Total number of items
            let currentDraggedItem = null;
            let matchedPairs = 0; // Number of currently correctly matched pairs
            let score = 0; // Total score (can be same as matchedPairs for this game)
            let allTargetsFilled = false; // Tracks if all drop targets have an item

            // --- Helper Functions (Moved to top for definition before use) ---

            function updateDisplays() {
                matchedCountDisplay.textContent = `–ó—ñ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${matchedPairs}/${totalItems}`;
                scoreDisplay.textContent = `‚ú® ${score}`;
                // Progress bar shows percentage of *correctly* matched items
                progressBarFill.style.width = `${(matchedPairs / totalItems) * 100}%`;

                // Show check answers button only when all targets have an item (regardless of correctness)
                if (allTargetsFilled) {
                    checkAnswersBtn.classList.remove('hidden');
                } else {
                    checkAnswersBtn.classList.add('hidden');
                }
            }

            function updateOverallScoreAndProgress() {
                let currentMatchedPairs = 0;
                let currentScore = 0;
                let filledTargetsCount = 0; // Count how many targets have an item

                dropTargetsContainer.querySelectorAll('.drop-target').forEach(target => {
                    const itemInTarget = target.querySelector('.draggable-item');
                    if (itemInTarget) {
                        filledTargetsCount++; // An item is present in this target
                        const droppedItemName = itemInTarget.dataset.itemName;
                        const correctItemName = target.dataset.correctItem;
                        if (droppedItemName === correctItemName) {
                            currentMatchedPairs++;
                            currentScore++;
                        }
                    }
                });

                matchedPairs = currentMatchedPairs;
                score = currentScore;
                allTargetsFilled = (filledTargetsCount === totalItems);

                updateDisplays(); // Call updateDisplays after updating counts
            }

            function handleDragStart(event) {
                currentDraggedItem = event.target;
                event.dataTransfer.setData('text/plain', event.target.dataset.itemName);
                event.target.classList.add('dragging');
            }

            function handleDragOver(event) {
                event.preventDefault(); // Allow drop
                event.target.classList.add('hovered');
            }

            function handleDragLeave(event) {
                event.target.classList.remove('hovered');
            }

            function handleDrop(event) {
                event.preventDefault();
                event.target.classList.remove('hovered');

                // Get the target element where the item is dropped
                const dropTarget = event.target.closest('.drop-target');

                // If there's already an item in the target, return it to the draggable container
                const previousItemInTarget = dropTarget.querySelector('.draggable-item');
                if (previousItemInTarget) {
                    draggableItemsContainer.appendChild(previousItemInTarget);
                    // Clear its previous visual state
                    previousItemInTarget.classList.remove('correct', 'incorrect');
                }

                // Append the dragged item to the drop target
                dropTarget.appendChild(currentDraggedItem);
                currentDraggedItem.classList.remove('dragging');
                
                // Clear visual feedback on drop (will be re-evaluated on check)
                dropTarget.classList.remove('correct', 'incorrect');
                currentDraggedItem.classList.remove('correct', 'incorrect');

                // Hide feedback and LLM explanation until check answers is clicked
                feedbackMessage.classList.add('hidden');
                llmExplanationDiv.classList.add('hidden');
                llmExplanationDiv.innerHTML = '';

                // Update overall score and progress based on current state of all drops
                updateOverallScoreAndProgress();
            }

            async function generateLlmExplanation(item, status, userAnswerText, correctAnswerText, description) {
                // The loading message is already set in checkAllAnswers, no need to set it here again.
                // We will append explanations.

                let prompt = `–ü–æ—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç–æ—é —ñ –¥–æ—Å—Ç—É–ø–Ω–æ—é –º–æ–≤–æ—é —Ä–æ–ª—å –∞–±–æ –∑–Ω–∞—á–µ–Ω–Ω—è "${item}" —É –ø–æ–µ–º—ñ –Ü–≤–∞–Ω–∞ –ö–æ—Ç–ª—è—Ä–µ–≤—Å—å–∫–æ–≥–æ "–ï–Ω–µ—ó–¥–∞" —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –æ–ø–∏—Å—É: "${description}". `;
                if (status === "correct") {
                    // This branch might not be hit if LLM is only for incorrect, but keep for robustness
                    prompt += `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑—ñ—Å—Ç–∞–≤–∏–≤ —Ü–µ–π –µ–ª–µ–º–µ–Ω—Ç. –î–æ–¥–∞–π —Ç—Ä–æ—Ö–∏ —Ü—ñ–∫–∞–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ç–µ, —è–∫ –ö–æ—Ç–ª—è—Ä–µ–≤—Å—å–∫–∏–π –π–æ–≥–æ –∑–æ–±—Ä–∞–∑–∏–≤.`;
                } else {
                    prompt += `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–º–∏–ª–∫–æ–≤–æ –∑—ñ—Å—Ç–∞–≤–∏–≤ "${item}" –∑ –æ–ø–∏—Å–æ–º: "${description}". –ü—Ä–∞–≤–∏–ª—å–Ω–∏–º –¥–ª—è —Ü—å–æ–≥–æ –æ–ø–∏—Å—É –±—É–≤ –±–∏ "${correctAnswerText}". –ü–æ—è—Å–Ω–∏, —á–æ–º—É "${item}" –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–æ —Ü—å–æ–≥–æ –æ–ø–∏—Å—É, —ñ —Ä–æ–∑–∫—Ä–∏–π —Å–ø—Ä–∞–≤–∂–Ω—é —Ä–æ–ª—å "${item}" —É –ø–æ–µ–º—ñ, –∞ —Ç–∞–∫–æ–∂ –ø–æ—è—Å–Ω–∏, —á–æ–º—É "${correctAnswerText}" —î –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é –¥–ª—è –æ–ø–∏—Å—É "${description}", —â–æ–± –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—é –∫—Ä–∞—â–µ.`;
                }

                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("Gemini API returned an error:", response.status, errorText);
                        llmExplanationDiv.innerHTML += `<div class="p-4 bg-red-50 border border-red-200 rounded-lg mt-4"><h4 class="font-semibold text-red-800 mb-2">–ü–æ–º–∏–ª–∫–∞ –¥–ª—è '${item}':</h4><p class="text-red-700">–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è. –°—Ç–∞—Ç—É—Å: ${response.status}. –î–µ—Ç–∞–ª—ñ: ${errorText.substring(0, 100)}...</p></div>`;
                        return;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        // Remove loading message if it's still there
                        if (llmExplanationDiv.innerHTML.includes('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—è—Å–Ω–µ–Ω—å')) {
                            llmExplanationDiv.innerHTML = ''; 
                        }
                        llmExplanationDiv.innerHTML += `<div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg mt-4"><h4 class="font-semibold text-emerald-800 mb-2">‚ú® –ü–æ—è—Å–Ω–µ–Ω–Ω—è –¥–ª—è '${item}':</h4><p class="text-emerald-700">${text}</p></div>`;
                    } else {
                        llmExplanationDiv.innerHTML += `<div class="p-4 bg-red-50 border border-red-200 rounded-lg mt-4"><h4 class="font-semibold text-red-800 mb-2">–ü–æ–º–∏–ª–∫–∞ –¥–ª—è '${item}':</h4><p class="text-red-700">–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –≤—ñ–¥ –®–Ü. –ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.</p></div>`;
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    llmExplanationDiv.innerHTML += `<div class="p-4 bg-red-50 border border-red-200 rounded-lg mt-4"><h4 class="font-semibold text-red-800 mb-2">–ü–æ–º–∏–ª–∫–∞ –¥–ª—è '${item}':</h4><p class="text-red-700">–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—è—Å–Ω–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∞–±–æ —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.</p></div>`;
                }
            }

            function checkAllAnswers() {
                // Clear all previous visual feedback before re-evaluating
                dropTargetsContainer.querySelectorAll('.drop-target').forEach(target => {
                    target.classList.remove('correct', 'incorrect');
                    const itemInTarget = target.querySelector('.draggable-item');
                    if (itemInTarget) {
                        itemInTarget.classList.remove('correct', 'incorrect');
                    }
                });
                draggableItemsContainer.querySelectorAll('.draggable-item').forEach(item => {
                    item.classList.remove('correct', 'incorrect');
                });

                feedbackMessage.classList.add('hidden');
                feedbackMessage.textContent = '';
                llmExplanationDiv.classList.add('hidden');
                llmExplanationDiv.innerHTML = ''; // Clear previous LLM explanations

                let allCorrect = true;
                let incorrectItemsInfo = []; // To store info for LLM explanations

                dropTargetsContainer.querySelectorAll('.drop-target').forEach(target => {
                    const itemInTarget = target.querySelector('.draggable-item');
                    
                    // If any target is empty, it's not all correct
                    if (!itemInTarget) {
                        allCorrect = false; 
                        return; // Skip to next target
                    }

                    const droppedItemName = itemInTarget.dataset.itemName;
                    const correctItemName = target.dataset.correctItem;

                    if (droppedItemName === correctItemName) {
                        target.classList.add('correct');
                        itemInTarget.classList.add('correct');
                    } else {
                        target.classList.add('incorrect');
                        itemInTarget.classList.add('incorrect');
                        allCorrect = false;
                        incorrectItemsInfo.push({
                            item: droppedItemName,
                            correct: correctItemName,
                            description: target.textContent // Pass the description for context in LLM
                        });
                    }
                });

                if (allCorrect) {
                    feedbackMessage.textContent = "–í—ñ—Ç–∞—î–º–æ! –£—Å—ñ –ø–∞—Ä–∏ –∑—ñ—Å—Ç–∞–≤–ª–µ–Ω—ñ –ø—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ";
                    feedbackMessage.className = 'message-box bg-emerald-50 border-emerald-200 text-emerald-700';
                    feedbackMessage.classList.remove('hidden');
                } else {
                    feedbackMessage.textContent = "–Ñ –ø–æ–º–∏–ª–∫–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–∏–¥—ñ–ª–µ–Ω—ñ —á–µ—Ä–≤–æ–Ω–∏–º —Å–ª–æ–≤–∞. ü§î";
                    feedbackMessage.className = 'message-box bg-red-50 border-red-200 text-red-700';
                    feedbackMessage.classList.remove('hidden');

                    // Generate LLM explanations for incorrect items
                    llmExplanationDiv.innerHTML = '<p class="text-center text-stone-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—è—Å–Ω–µ–Ω—å –≤—ñ–¥ –®–Ü...</p>';
                    llmExplanationDiv.classList.remove('hidden');
                    incorrectItemsInfo.forEach(info => {
                        generateLlmExplanation(info.item, "incorrect", info.item, info.correct, info.description);
                    });
                }
                // Update score display one last time after final check
                updateOverallScoreAndProgress();
                // Show results screen after checking answers
                showResults();
            }

            function showResults() {
                quizScreen.classList.add('hidden');
                resultsScreen.classList.remove('hidden');
                progressBarFill.style.width = '100%'; 
                
                finalScoreDisplay.textContent = `${score}/${totalItems}`;

                let message = '';
                const percentage = (score / totalItems) * 100;
                if (percentage === 100) {
                    message = "–ù–µ–π–º–æ–≤—ñ—Ä–Ω–æ! –¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –ú–∞–π—Å—Ç–µ—Ä '–ï–Ω–µ—ó–¥–∏'! ü§©";
                    finalScoreDisplay.classList.add('text-emerald-600');
                    finalScoreDisplay.classList.remove('text-amber-600', 'text-red-500');
                } else if (percentage >= 60) {
                    message = "–ú–æ–ª–æ–¥–µ—Ü—å! –¢–∏ —á—É–¥–æ–≤–æ –∑–Ω–∞—î—à –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤ '–ï–Ω–µ—ó–¥–∏'. –ü—Ä–æ–¥–æ–≤–∂—É–π —É —Ç–æ–º—É –∂ –¥—É—Å—ñ! üëç";
                    finalScoreDisplay.classList.add('text-amber-600');
                    finalScoreDisplay.classList.remove('text-emerald-600', 'text-red-500');
                } else {
                    message = "–ù–µ –∑–∞—Å–º—É—á—É–π—Å—è! '–ï–Ω–µ—ó–¥–∞' ‚Äì —Ü–µ —Ü—ñ–ª–∏–π —Å–≤—ñ—Ç, —ñ –π–æ–≥–æ –≤–∞—Ä—Ç–æ –¥–æ—Å–ª—ñ–¥–∂—É–≤–∞—Ç–∏ –¥–∞–ª—ñ. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑, —ñ –≤—Å–µ –≤–∏–π–¥–µ! üí™";
                    finalScoreDisplay.classList.add('text-red-500');
                    finalScoreDisplay.classList.remove('text-emerald-600', 'text-amber-600');
                }
                resultMessage.textContent = message;
            }

            // --- Game Logic ---

            startGameBtn.addEventListener('click', startGame);
            restartGameBtn.addEventListener('click', startGame);
            checkAnswersBtn.addEventListener('click', checkAllAnswers);

            function startGame() {
                introScreen.classList.add('hidden');
                resultsScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');

                matchedPairs = 0;
                score = 0;
                allTargetsFilled = false;
                updateDisplays(); // Initialize displays
                renderGame();
            }

            function renderGame() {
                draggableItemsContainer.innerHTML = '';
                dropTargetsContainer.innerHTML = '';
                feedbackMessage.classList.add('hidden');
                llmExplanationDiv.classList.add('hidden');
                llmExplanationDiv.innerHTML = '';

                // Shuffle gameData for random order of descriptions
                const shuffledDescriptions = [...gameData].sort(() => Math.random() - 0.5);
                const shuffledItems = [...gameData].sort(() => Math.random() - 0.5); // Shuffle items too

                shuffledItems.forEach(data => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'draggable-item';
                    itemDiv.textContent = data.item;
                    itemDiv.draggable = true;
                    itemDiv.dataset.itemName = data.item; // Store original item name
                    itemDiv.addEventListener('dragstart', handleDragStart);
                    draggableItemsContainer.appendChild(itemDiv);
                });

                shuffledDescriptions.forEach(data => {
                    const targetDiv = document.createElement('div');
                    targetDiv.className = 'drop-target';
                    targetDiv.textContent = data.description;
                    targetDiv.dataset.correctItem = data.item; // Store the correct item for this description
                    targetDiv.addEventListener('dragover', handleDragOver);
                    targetDiv.addEventListener('dragleave', handleDragLeave);
                    targetDiv.addEventListener('drop', handleDrop);
                    dropTargetsContainer.appendChild(targetDiv);
                });

                checkAnswersBtn.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
